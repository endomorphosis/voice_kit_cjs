(()=>{var e,r,t,o,a,n={144:()=>{},747:()=>{},591:()=>{},162:()=>{},405:()=>{},33:()=>{},359:()=>{},322:(e,r,t)=>{"use strict";var o=t(470);const a=new class{constructor(){this.modelCache=new Map}async init(){try{const e=await chrome.storage.local.get("modelCache");e.modelCache&&(this.modelCache=new Map(JSON.parse(e.modelCache)))}catch(e){console.error("Failed to initialize cache:",e)}}async saveToStorage(){try{await chrome.storage.local.set({modelCache:JSON.stringify(Array.from(this.modelCache.entries()))})}catch(e){console.error("Failed to save cache:",e)}}async set(e,r){this.modelCache.set(e,r),await this.saveToStorage()}async get(e){return this.modelCache.get(e)}async has(e){return this.modelCache.has(e)}async delete(e){const r=this.modelCache.delete(e);return await this.saveToStorage(),r}async clear(){this.modelCache.clear(),await this.saveToStorage()}};a.init().catch(console.error),o._K2.useBrowserCache=!0,o._K2.allowLocalModels=!0,o._K2.allowRemoteModels=!0,o._K2.useModelCaching=!0,o._K2.localModelPath=chrome.runtime.getURL("models"),o._K2.cacheDir=o._K2.localModelPath,o._K2.useFS=!1,o._K2.wasmPaths={"ort-wasm-simd-threaded.wasm":chrome.runtime.getURL("wasm/ort-wasm-simd-threaded.wasm"),"ort-wasm-simd.wasm":chrome.runtime.getURL("wasm/ort-wasm-simd.wasm"),"ort-wasm-threaded.wasm":chrome.runtime.getURL("wasm/ort-wasm-threaded.wasm"),"ort-wasm.wasm":chrome.runtime.getURL("wasm/ort-wasm.wasm")},o._K2.backends=["wasm"],o._K2.quantized=!0;const n={TEXT:{modelId:"Xenova/gpt2-small",type:"text-generation",files:["tokenizer.json","tokenizer_config.json","config.json","model.onnx"]},ASR:{modelId:"Xenova/whisper-small",type:"automatic-speech-recognition",files:["preprocessor_config.json","tokenizer.json","tokenizer_config.json","config.json","decoder_model_merged.onnx","encoder_model.onnx"]}};async function s(){try{const e=Object.keys(o._K2.wasmPaths);await Promise.all(e.map((async e=>{const r=await fetch(o._K2.wasmPaths[e]);if(!r.ok)throw new Error(`Failed to load ${e}`);const t=await r.arrayBuffer();await WebAssembly.compile(t)})))}catch(e){throw console.error("WASM initialization error:",e),e}}const i=async e=>{try{await s();for(const[r,t]of Object.entries(n))try{const n={quantized:!0,progress_callback:e,cache_dir:o._K2.cacheDir,local_files_only:!1,revision:"main"};await(0,o.TkF)(t.type,t.modelId,n),await a.set(`${r}_${t.modelId}`,{type:t.type,modelId:t.modelId,timestamp:Date.now()}),console.log(`Successfully cached ${r} model`)}catch(e){throw console.error(`Error loading ${r} model:`,e),e}return!0}catch(e){throw console.error("Error pre-downloading models:",e),e}},c=async()=>{try{return await s(),(await Promise.all(Object.entries(n).map((async([e,r])=>{try{const e={quantized:!0,local_files_only:!0,cache_dir:o._K2.cacheDir,revision:"main"};return await(0,o.TkF)(r.type,r.modelId,e),!0}catch(r){return console.warn(`Error checking ${e} model:`,r),!1}})))).every(Boolean)}catch(e){return console.error("Error checking model cache:",e),!1}},l="generate";o._K2.useBrowserCache=!1,o._K2.useCustomCache=!0,o._K2.localModelPath=chrome.runtime.getURL("models"),o._K2.backends=["wasm"],o._K2.wasmRoot=chrome.runtime.getURL("wasm/");let d=null;async function m(){if(!d)try{d=await(0,o.TkF)("text-generation","Xenova/gpt2-small",{quantized:!0}),console.log("LLM initialized successfully")}catch(e){throw console.error("Failed to initialize LLM:",e),e}}const u={modelStatus:"uninitialized",loadingProgress:0,whisperPipeline:null,textPipeline:null,contextMenuCreated:!1,stopping_criteria:{shouldStop:!1,call:async()=>(void 0).shouldStop,interrupt:()=>{(void 0).shouldStop=!0},reset:()=>{(void 0).shouldStop=!1}}},h=async(e,r=null)=>{const t=[],o=new MessageChannel;t.push(o.port1),t.forEach((t=>{t.postMessage({status:e,data:r,progress:u.loadingProgress})}))};async function w(){if(u.whisperPipeline)return u.whisperPipeline;try{const e={quantized:!0,progress_callback:e=>{e&&"number"==typeof e.progress&&(u.loadingProgress=e.progress,h("loading",e))},cache_dir:o._K2.cacheDir,revision:"main"};if(u.whisperPipeline=await(0,o.TkF)("automatic-speech-recognition","Xenova/whisper-small",e),!u.whisperPipeline)throw new Error("Failed to initialize ASR pipeline");return u.modelStatus="ready",await h("ready"),u.whisperPipeline}catch(e){throw u.modelStatus="error",await h("error",e.message),e}}async function g(){try{await c()||await i((e=>{"number"==typeof e.progress&&(u.loadingProgress=e.progress,h("loading",{status:"downloading",model:e.model,file:e.file,progress:u.loadingProgress}))})),await w(),u.contextMenuCreated||(await chrome.contextMenus.removeAll(),await chrome.contextMenus.create({id:l,title:'Generate from "%s"',contexts:["selection"]}),u.contextMenuCreated=!0)}catch(e){throw console.error("Error initializing extension:",e),u.modelStatus="error",await h("error",e.message),e}}function p(e){return e?String(e).trim():""}Date.now(),self.addEventListener("install",(e=>{e.waitUntil(Promise.all([self.skipWaiting(),g()]))})),self.addEventListener("activate",(e=>{e.waitUntil(Promise.all([self.clients.claim(),g()]))})),self.addEventListener("message",(async e=>{const{type:r,data:t,port:o}=e.data||{};if(r&&"string"==typeof r)try{switch(r){case"check_status":o?.postMessage({status:u.modelStatus,progress:u.loadingProgress});break;case"transcribe":if(!t?.audio)throw new Error("No audio data provided");const e=await async function(e){const r=await w();if(!r)throw new Error("ASR pipeline not initialized");let t;try{if(e instanceof Float32Array)t=e;else if(ArrayBuffer.isView(e))t=new Float32Array(e.buffer);else{if(!Array.isArray(e))throw new Error("Invalid audio data format");if(!e.every((e=>"number"==typeof e&&!isNaN(e))))throw new Error("Invalid audio data - must contain only valid numbers");t=Float32Array.from(e)}}catch(e){throw new Error(`Failed to process audio data: ${e.message}`)}const o=await r(t);return p(o?.text)}(t.audio);o?.postMessage({success:!0,text:e});break;default:o?.postMessage({error:`Unknown message type: ${r}`})}}catch(e){o?.postMessage({error:e.message})}else o?.postMessage({error:"Invalid message format"})})),chrome.contextMenus.onClicked.addListener((async(e,r)=>{if(e.menuItemId===l&&r?.id)try{const t=e.selectionText;if(!t?.trim())throw new Error("No text selected");const a={quantized:!0,cache_dir:o._K2.cacheDir,revision:"main"},n=await(0,o.TkF)("text-generation","Xenova/gpt2-small",a),s=await n(t,{max_new_tokens:256,temperature:.7,top_p:.95,do_sample:!0});await chrome.tabs.sendMessage(r.id,{action:"showResult",result:s[0]?.generated_text||"No result generated",userText:t})}catch(e){await chrome.tabs.sendMessage(r.id,{action:"showError",error:e.message})}})),chrome.runtime.onMessage.addListener(((e,r,t)=>{if(!e||"object"!=typeof e)return t({error:"Invalid message format"}),!0;const o=(async()=>{try{const r=await async function(e){let r=3;for(;r>0;)try{switch(e.action){case"generate":d||await m();const r=p(e.text),t=await d(r,{max_new_tokens:50,temperature:.7});return{text:p(t[0]?.generated_text)};case"checkGPU":return{hasWebGPU:!1};default:throw new Error(`Unknown action: ${e.action}`)}}catch(e){if(r--,0===r)throw e;await new Promise((e=>setTimeout(e,1e3)))}}(e);if(chrome.runtime.lastError)throw new Error(chrome.runtime.lastError.message);return r}catch(e){return console.error("Message handling error:",e),{error:e.message}}})();return o.then((e=>{try{if(chrome.runtime.lastError)return void console.error("Runtime error:",chrome.runtime.lastError);t(e)}catch(e){console.error("Response error:",e)}})),!0})),chrome.runtime.onInstalled.addListener((()=>{(async()=>{try{u.modelStatus="loading",h("loading","Initializing models..."),await c()||await i((e=>{u.loadingProgress=e.progress||0,h("loading",e)})),u.modelStatus="ready",h("ready")}catch(e){throw console.error("Error initializing extension:",e),u.modelStatus="error",h("error",e.message),e}})().catch(console.error),m().catch(console.error)})),console.log("Background service worker running."),chrome.runtime.onMessage.addListener(((e,r,o)=>{if(console.log("Received message in background:",e),"initialize"===e.type)return t.e(486).then(t.bind(t,486)).then((e=>{e.initializeModel().then((()=>{o({status:"initialized"})})).catch((e=>{o({status:"error",error:String(e)})}))})),!0;o({status:"unrecognized message"})})),chrome.runtime.onInstalled.addListener((()=>{console.log("Extension installed")})),chrome.action.onClicked.addListener((async e=>{const{modelLoader:r}=await t.e(486).then(t.bind(t,486)),o=await r.loadModel("Xenova/whisper-small");console.log("Model loaded:",o)}))}},s={};function i(e){var r=s[e];if(void 0!==r)return r.exports;var t=s[e]={exports:{}};return n[e](t,t.exports,i),t.exports}i.m=n,e=[],i.O=(r,t,o,a)=>{if(!t){var n=1/0;for(d=0;d<e.length;d++){for(var[t,o,a]=e[d],s=!0,c=0;c<t.length;c++)(!1&a||n>=a)&&Object.keys(i.O).every((e=>i.O[e](t[c])))?t.splice(c--,1):(s=!1,a<n&&(n=a));if(s){e.splice(d--,1);var l=o();void 0!==l&&(r=l)}}return r}a=a||0;for(var d=e.length;d>0&&e[d-1][2]>a;d--)e[d]=e[d-1];e[d]=[t,o,a]},t=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,i.t=function(e,o){if(1&o&&(e=this(e)),8&o)return e;if("object"==typeof e&&e){if(4&o&&e.__esModule)return e;if(16&o&&"function"==typeof e.then)return e}var a=Object.create(null);i.r(a);var n={};r=r||[null,t({}),t([]),t(t)];for(var s=2&o&&e;"object"==typeof s&&!~r.indexOf(s);s=t(s))Object.getOwnPropertyNames(s).forEach((r=>n[r]=()=>e[r]));return n.default=()=>e,i.d(a,n),a},i.d=(e,r)=>{for(var t in r)i.o(r,t)&&!i.o(e,t)&&Object.defineProperty(e,t,{enumerable:!0,get:r[t]})},i.f={},i.e=e=>Promise.all(Object.keys(i.f).reduce(((r,t)=>(i.f[t](e,r),r)),[])),i.u=e=>e+".js",i.o=(e,r)=>Object.prototype.hasOwnProperty.call(e,r),o={},a="browser-extension:",i.l=(e,r,t,n)=>{if(o[e])o[e].push(r);else{var s,c;if(void 0!==t)for(var l=document.getElementsByTagName("script"),d=0;d<l.length;d++){var m=l[d];if(m.getAttribute("src")==e||m.getAttribute("data-webpack")==a+t){s=m;break}}s||(c=!0,(s=document.createElement("script")).charset="utf-8",s.timeout=120,i.nc&&s.setAttribute("nonce",i.nc),s.setAttribute("data-webpack",a+t),s.src=e),o[e]=[r];var u=(r,t)=>{s.onerror=s.onload=null,clearTimeout(h);var a=o[e];if(delete o[e],s.parentNode&&s.parentNode.removeChild(s),a&&a.forEach((e=>e(t))),r)return r(t)},h=setTimeout(u.bind(null,void 0,{type:"timeout",target:s}),12e4);s.onerror=u.bind(null,s.onerror),s.onload=u.bind(null,s.onload),c&&document.head.appendChild(s)}},i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.p="",(()=>{var e={471:0};i.f.j=(r,t)=>{var o=i.o(e,r)?e[r]:void 0;if(0!==o)if(o)t.push(o[2]);else{var a=new Promise(((t,a)=>o=e[r]=[t,a]));t.push(o[2]=a);var n=i.p+i.u(r),s=new Error;i.l(n,(t=>{if(i.o(e,r)&&(0!==(o=e[r])&&(e[r]=void 0),o)){var a=t&&("load"===t.type?"missing":t.type),n=t&&t.target&&t.target.src;s.message="Loading chunk "+r+" failed.\n("+a+": "+n+")",s.name="ChunkLoadError",s.type=a,s.request=n,o[1](s)}}),"chunk-"+r,r)}},i.O.j=r=>0===e[r];var r=(r,t)=>{var o,a,[n,s,c]=t,l=0;if(n.some((r=>0!==e[r]))){for(o in s)i.o(s,o)&&(i.m[o]=s[o]);if(c)var d=c(i)}for(r&&r(t);l<n.length;l++)a=n[l],i.o(e,a)&&e[a]&&e[a][0](),e[a]=0;return i.O(d)},t=self.webpackChunkbrowser_extension=self.webpackChunkbrowser_extension||[];t.forEach(r.bind(null,0)),t.push=r.bind(null,t.push.bind(t))})();var c=i.O(void 0,[96],(()=>i(322)));c=i.O(c)})();