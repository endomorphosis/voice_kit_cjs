(()=>{var e,t,n,o={711:(e,t,n)=>{"use strict";var o=n(969);const s={TEXT:"onnx-community/DeepSeek-R1-Distill-Qwen-1.5B-ONNX",ASR:"onnx-community/whisper-tiny.en"};async function r(e){await caches.open("model-cache-v1");for(const[t,n]of Object.entries(s))try{console.log(`Pre-downloading ${t} model: ${n}`),await(0,o.TkF)("ASR"===t?"automatic-speech-recognition":"text-generation",n,{cache_dir:"models",local_files_only:!1,progress_callback:n=>{e&&e({model:t,...n})}}),console.log(`Successfully cached ${t} model`)}catch(e){console.error(`Error pre-downloading ${t} model:`,e)}}async function i(){try{const e=await caches.open("model-cache-v1");return(await Promise.all(Object.values(s).map((async t=>(await e.keys(`models/${t}/*`)).length>0)))).every(Boolean)}catch(e){return console.error("Error checking model cache:",e),!1}}const a="generate-from-selection",l=new o.dYU;let c="uninitialized",d=0;function p(e,t=null){"loading"===e&&t?.status&&console.log(`[${(new Date).toISOString()}] Loading progress:`,t),chrome.runtime.sendMessage({status:e,data:t,progress:d}).catch((()=>{}))}class g{static model_id="onnx-community/DeepSeek-R1-Distill-Qwen-1.5B-ONNX";static instance=null;static lastUsed=Date.now();static memoryCleanupInterval=3e5;static async getInstance(e=null){const t=Date.now();if(this.instance&&t-this.lastUsed>this.memoryCleanupInterval){console.log("Cleaning up old model instance to free memory...");try{this.instance.model?.destroy&&await this.instance.model.destroy(),this.instance.tokenizer?.destroy&&await this.instance.tokenizer.destroy(),this.instance=null,n.g.gc&&n.g.gc()}catch(e){console.warn("Error cleaning up model:",e)}}if(this.instance)return this.lastUsed=t,p("ready"),this.instance;try{console.time("totalModelLoading"),c="loading",p("loading");const n=t=>{void 0!==t.progress&&(d=t.progress,console.log(`[${(new Date).toISOString()}] Loading step:`,{file:t.file,status:t.status,progress:t.progress}),p("loading",t)),e&&e(t)};try{if(console.time("webgpuInit"),!navigator.gpu)throw new Error("WebGPU is not supported in this browser");const e=await navigator.gpu.requestAdapter();if(!e)throw new Error("Failed to get WebGPU adapter");let t,s=[];try{t=await e.requestDevice({requiredFeatures:["shader-f16"]}),s.push("shader-f16")}catch(n){console.log("F16 shaders not supported, using standard WebGPU"),t=await e.requestDevice()}const r={maxStorageBufferBindingSize:Math.min(e.limits.maxStorageBufferBindingSize,2147483648),maxBufferSize:Math.min(e.limits.maxBufferSize,2147483648)};console.log("Using WebGPU adapter:",{name:e.name,features:Array.from(e.features),limits:r});const i={executionProviders:["webgpu","cpu"],graphOptimizationLevel:99,enableMemoryPattern:!1,executionMode:"sequential",enableCpuMemArena:!1,webgpu:{gpuDevice:t,preferredLayout:"nchw",deviceType:"discrete",shaderPreprocess:!0,useHostMemory:!1}};s.includes("shader-f16")&&(i.webgpu.shader_features=["f16"]),console.timeEnd("webgpuInit"),console.time("tokenizerLoading"),this.tokenizer=await o.v6I.from_pretrained(this.model_id,{progress_callback:n,cache_dir:"models",local_files_only:!0,truncation:!0,max_length:2048}),console.timeEnd("tokenizerLoading"),console.time("modelLoading"),this.model=await o.W6E.from_pretrained(this.model_id,{...i,progress_callback:n,cache_dir:"models",local_files_only:!0,load_in_8bit:!0,torch_dtype:"float16"}),console.timeEnd("modelLoading")}catch(e){console.warn("WebGPU initialization failed, falling back to WASM:",e),this.tokenizer=await o.v6I.from_pretrained(this.model_id,{progress_callback:n}),this.model=await o.W6E.from_pretrained(this.model_id,{device:"wasm",progress_callback:n}),console.log("Successfully initialized on WASM")}this.instance={tokenizer:this.tokenizer,model:this.model,destroy:async()=>{try{this.model?.destroy&&await this.model.destroy(),this.tokenizer?.destroy&&await this.tokenizer.destroy()}catch(e){console.warn("Error destroying model:",e)}}},this.lastUsed=t,c="ready",p("ready"),console.timeEnd("totalModelLoading");const s=setInterval((()=>{Date.now()-this.lastUsed>this.memoryCleanupInterval&&(console.log("Auto-cleaning unused model instance..."),clearInterval(s),this.instance?.destroy(),this.instance=null)}),this.memoryCleanupInterval);return this.instance}catch(e){c="error";const t=e.message.includes("WebGPU")?`WebGPU error: ${e.message}. Falling back to WASM...`:e.message;throw p("error",t),new Error(t)}}}chrome.runtime.onSuspend.addListener((async()=>{g.instance&&(console.log("Cleaning up model on extension unload..."),await g.instance.destroy(),g.instance=null)}));const m=async e=>{console.log("Starting text generation for:",e);try{globalThis.__TRANSFORMER_WORKER_WASM_PATH__="/wasm/",console.log("Getting pipeline instance...");const{tokenizer:t,model:n}=await g.getInstance((e=>{console.log("Loading model progress:",e)}));console.log("Pipeline instance ready");const o=[{role:"user",content:e}];console.log("Applying chat template...");const s=t.apply_chat_template(o,{add_generation_prompt:!0,return_dict:!0,max_length:2048});if(console.log("Tokenized input:",{inputIds:s.input_ids?.length,attentionMask:s.attention_mask?.length}),s.input_ids?.length>2048)throw new Error("Input is too long - please provide shorter text");console.log("Starting model generation...");try{const{sequences:e}=await n.generate({...s,do_sample:!1,max_new_tokens:512,min_new_tokens:1,max_length:2048,pad_token_id:t.pad_token_id,eos_token_id:t.eos_token_id,stopping_criteria:l,return_dict_in_generate:!0,repetition_penalty:1.2,no_repeat_ngram_size:3,early_stopping:!0});console.log("Decoding generated sequences...");const o=t.batch_decode(e,{skip_special_tokens:!0});return console.log("Generation complete:",o[0]),o[0]}catch(e){if(e.message?.includes("1879778072")){console.error("ONNX memory allocation error:",e),console.log("Attempting recovery with smaller context...");const o={...s,input_ids:s.input_ids.slice(-512),attention_mask:s.attention_mask.slice(-512)},{sequences:r}=await n.generate({...o,do_sample:!1,max_new_tokens:256,min_new_tokens:1,max_length:768,pad_token_id:t.pad_token_id,eos_token_id:t.eos_token_id,stopping_criteria:l,return_dict_in_generate:!0,repetition_penalty:1.2,no_repeat_ngram_size:3,early_stopping:!0});return t.batch_decode(r,{skip_special_tokens:!0})[0]+"\n\n(Note: Response was truncated due to length)"}throw e}}catch(t){if(console.error("Error in generate function:",{name:t.name,message:t.message,stack:t.stack,inputs:e?.length}),t.message?.includes("1879778072"))throw new Error("The model ran out of memory. Please try with shorter input text.");throw t}};chrome.runtime.onInstalled.addListener((async e=>{chrome.contextMenus.create({id:a,title:'Generate from "%s"',contexts:["selection"]}),await i()||(console.log("Starting model pre-download..."),r((e=>{p("loading",{status:"downloading",model:e.model,file:e.file,progress:e.progress})})))})),chrome.contextMenus.onClicked.addListener((async(e,t)=>{if(console.log("Context menu clicked:",e),e.menuItemId===a&&e.selectionText)try{console.log("Generating text from selection:",e.selectionText);const n=await m(e.selectionText);console.log("Generated result:",n),chrome.scripting.executeScript({target:{tabId:t.id},args:[n],function:e=>{const t=document.createElement("div");t.id="copilot-chat-container",t.style.cssText="\n          position: fixed;\n          top: 20px;\n          right: 20px;\n          width: 400px;\n          max-height: 80vh;\n          background: white;\n          border: 1px solid #ccc;\n          border-radius: 8px;\n          box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n          z-index: 10000;\n          display: flex;\n          flex-direction: column;\n        ";const n=document.createElement("div");n.style.cssText="\n          padding: 12px;\n          border-bottom: 1px solid #eee;\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n        ",n.innerHTML='<span style="font-weight: bold;">AI Response</span>';const o=document.createElement("button");o.textContent="Ã—",o.style.cssText="\n          border: none;\n          background: none;\n          cursor: pointer;\n          font-size: 20px;\n          padding: 0 4px;\n        ",o.onclick=()=>t.remove(),n.appendChild(o);const s=document.createElement("div");s.style.cssText="\n          padding: 16px;\n          overflow-y: auto;\n          font-size: 14px;\n          line-height: 1.5;\n        ";const r=document.createElement("div");r.style.cssText="\n          margin-bottom: 12px;\n          padding: 8px 12px;\n          background: #f0f0f0;\n          border-radius: 8px;\n        ",r.textContent=window.getSelection().toString();const i=document.createElement("div");i.style.cssText="\n          padding: 8px 12px;\n          background: #e3f2fd;\n          border-radius: 8px;\n          white-space: pre-wrap;\n        ",i.textContent=e,s.appendChild(r),s.appendChild(i),t.appendChild(n),t.appendChild(s),document.body.appendChild(t),console.log("Chat UI created and displayed")}})}catch(e){console.error("Error handling context menu click:",e),chrome.scripting.executeScript({target:{tabId:t.id},args:[e.message],function:e=>{alert("Error: "+e)}})}})),chrome.runtime.onMessage.addListener(((e,t,n)=>(console.log("Received message:",e),"check_status"===e.type?(n({status:c,progress:d}),!0):"generate"===e.action&&(async function(){try{console.log("Generating response for message:",e);const t=await m(e.text);console.log("Generated response:",t),n(t)}catch(e){console.error("Error handling message:",e),n({error:e.message})}}(),!0)))),chrome.runtime.onConnect.addListener((e=>{"popup"===e.name&&(e.onDisconnect.addListener((()=>{console.log("Popup disconnected")})),e.onMessage.addListener((t=>{"check_status"===t.type&&e.postMessage({status:c,progress:d})})))})),chrome.runtime.onStartup.addListener((()=>{console.log("Extension starting up")})),chrome.runtime.onSuspend.addListener((async()=>{console.log("Extension being suspended"),g.instance&&(await g.instance.destroy(),g.instance=null)})),chrome.runtime.onInstalled.addListener((async e=>{console.log("Extension installed/updated:",e.reason),chrome.contextMenus.create({id:a,title:'Generate from "%s"',contexts:["selection"]}),await i()||(console.log("Starting model pre-download..."),r((e=>{p("loading",{status:"downloading",model:e.model,file:e.file,progress:e.progress})})))}))},193:()=>{},160:()=>{},448:()=>{},655:()=>{},626:()=>{},674:()=>{},666:()=>{}},s={};function r(e){var t=s[e];if(void 0!==t)return t.exports;var n=s[e]={exports:{}};return o[e](n,n.exports,r),n.exports}r.m=o,e=[],r.O=(t,n,o,s)=>{if(!n){var i=1/0;for(d=0;d<e.length;d++){for(var[n,o,s]=e[d],a=!0,l=0;l<n.length;l++)(!1&s||i>=s)&&Object.keys(r.O).every((e=>r.O[e](n[l])))?n.splice(l--,1):(a=!1,s<i&&(i=s));if(a){e.splice(d--,1);var c=o();void 0!==c&&(t=c)}}return t}s=s||0;for(var d=e.length;d>0&&e[d-1][2]>s;d--)e[d]=e[d-1];e[d]=[n,o,s]},n=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,r.t=function(e,o){if(1&o&&(e=this(e)),8&o)return e;if("object"==typeof e&&e){if(4&o&&e.__esModule)return e;if(16&o&&"function"==typeof e.then)return e}var s=Object.create(null);r.r(s);var i={};t=t||[null,n({}),n([]),n(n)];for(var a=2&o&&e;"object"==typeof a&&!~t.indexOf(a);a=n(a))Object.getOwnPropertyNames(a).forEach((t=>i[t]=()=>e[t]));return i.default=()=>e,r.d(s,i),s},r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.p="/",(()=>{r.b=document.baseURI||self.location.href;var e={471:0};r.O.j=t=>0===e[t];var t=(t,n)=>{var o,s,[i,a,l]=n,c=0;if(i.some((t=>0!==e[t]))){for(o in a)r.o(a,o)&&(r.m[o]=a[o]);if(l)var d=l(r)}for(t&&t(n);c<i.length;c++)s=i[c],r.o(e,s)&&e[s]&&e[s][0](),e[s]=0;return r.O(d)},n=self.webpackChunkbrowser_extension=self.webpackChunkbrowser_extension||[];n.forEach(t.bind(null,0)),n.push=t.bind(null,n.push.bind(n))})();var i=r.O(void 0,[96],(()=>r(711)));i=r.O(i)})();
//# sourceMappingURL=background.js.map